<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.4">
    <meta name="project" content="Lightning v2.14.14">


    <title>Deployment ‚Äî Lightning v2.14.14</title>

    <link rel="stylesheet" href="dist/html-elixir-RLZO5U2C.css" />

    <script defer src="dist/sidebar_items-777DBDD4.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-Y223O6DN.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://openfn.github.io/lightning" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="Lightning" />
        </a>

      <div>
        <a href="https://openfn.github.io/lightning" class="sidebar-projectName" translate="no">
Lightning
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v2.14.14
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of Lightning</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Deployment</h1>


      <a href="https://github.com/OpenFn/lightning/blob/main/DEPLOYMENT.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p>Head to the <a href="https://docs.openfn.org/documentation/deploy/options">Deploy</a>
section of our docs site to get started.</p><p>See below for technical considerations and instructions.</p><h2 id="encryption" class="section-heading"><a href="#encryption" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Encryption</span></h2><p>Lightning enforces encryption at rest for credentials, TOTP backup codes, and
webhook trigger authentication methods, for which an encryption key must be
provided when running in production.</p><p>The key is expected to be a randomized set of bytes, 32 long; and Base64 encoded
when setting the environment variable.</p><p>There is a mix task that can generate keys in the correct shape for use as an
environment variable:</p><pre><code class="makeup sh" translate="no"><span class="">mix lightning.gen_encryption_key
</span><span class="">0bJ9w+hn4ebQrsCaWXuA9JY49fP9kbHmywGd5K7k+/s=
</span></code></pre><p>Copy your key <em>(NOT THIS ONE)</em> and set it as <code class="inline">PRIMARY_ENCRYPTION_KEY</code> in your
environment.</p><h2 id="workers" class="section-heading"><a href="#workers" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Workers</span></h2><p>Lightning uses external worker processes for executing Runs. There are three
settings required to configure worker authentication.</p><ul><li><code class="inline">WORKER_RUNS_PRIVATE_KEY</code></li><li><code class="inline">WORKER_LIGHTNING_PUBLIC_KEY</code></li><li><code class="inline">WORKER_SECRET</code></li></ul><p>You can use the <a href="Mix.Tasks.Lightning.GenWorkerKeys.html"><code class="inline">mix lightning.gen_worker_keys</code></a> task to generate these for
convenience.</p><p>For more information see the <a href="workers.html">Workers</a> documentation.</p><h2 id="environment-variables" class="section-heading"><a href="#environment-variables" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Environment Variables</span></h2><p>Note that for secure deployments, it's recommended to use a combination of
<code class="inline">secrets</code> and <code class="inline">configMaps</code> to generate secure environment variables.</p><h3 id="limits" class="section-heading"><a href="#limits" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Limits</span></h3><ul><li><code class="inline">WORKER_MAX_RUN_MEMORY_MB</code> - how much memory (in MB) can a single run use?</li><li><code class="inline">RUN_GRACE_PERIOD_SECONDS</code> - how long <em>after</em> the <code class="inline">MAX_RUN_DURATION_SECONDS</code>
should the server wait for the worker to send back data on a run.</li><li><code class="inline">WORKER_MAX_RUN_DURATION_SECONDS</code> - the maximum duration (in seconds) that
workflows are allowed to run (keep this plus <code class="inline">RUN_GRACE_PERIOD_SECONDS</code> below
your termination_grace_period if using kubernetes)</li><li><code class="inline">WORKER_CAPACITY</code> - the number of runs a ws-worker instance will take on
concurrently.</li><li><code class="inline">MAX_DATACLIP_SIZE_MB</code> - the maximum size (in MB) of a dataclip created via
the webhook trigger URL for a job. This limits the max request size via the
JSON plug and may (in future) limit the size of dataclips that can be stored
as run_results via the websocket connection from a worker.</li></ul><h3 id="github" class="section-heading"><a href="#github" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">GitHub</span></h3><p>Lightning enables connection to GitHub via GitHub Apps. The following GitHub
repository permissions are needed for the GitHub app:</p><table><thead><tr><th style="text-align: left;"><strong>Resource</strong></th><th style="text-align: left;"><strong>Access</strong></th></tr></thead><tbody><tr><td style="text-align: left;">Actions</td><td style="text-align: left;">Read and Write</td></tr><tr><td style="text-align: left;">Contents</td><td style="text-align: left;">Read and Write</td></tr><tr><td style="text-align: left;">Metadata</td><td style="text-align: left;">Read only</td></tr><tr><td style="text-align: left;">Secrets</td><td style="text-align: left;">Read and Write</td></tr><tr><td style="text-align: left;">Workflows</td><td style="text-align: left;">Read and Write</td></tr></tbody></table><p>Ensure you set the following URLs:</p><ul><li><strong>Homepage URL:</strong> <code class="inline">&lt;app_url_here&gt;</code></li><li><strong>Callback URL for authorizing users:</strong> <code class="inline">&lt;app_url_here&gt;/oauth/github/callback</code>
(Do NOT check the two checkboxes in this section requesting Device Flow and
OAuth.)</li><li><strong>Setup URL for Post installation:</strong> <code class="inline">&lt;app_url_here&gt;/setup_vcs</code> (Check the box
for <strong>Redirect on update</strong>)</li></ul><p>These environment variables will need to be set in order to configure the github
app:</p><table><thead><tr><th style="text-align: left;"><strong>Variable</strong></th><th style="text-align: left;"><strong>Description</strong></th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">GITHUB_APP_ID</code></td><td style="text-align: left;">the github app ID.</td></tr><tr><td style="text-align: left;"><code class="inline">GITHUB_APP_NAME</code></td><td style="text-align: left;">the github app name. This is the name used in the public link. It is the downcased name with spaces replaced with hyphens</td></tr><tr><td style="text-align: left;"><code class="inline">GITHUB_APP_CLIENT_ID</code></td><td style="text-align: left;">the github app Client ID</td></tr><tr><td style="text-align: left;"><code class="inline">GITHUB_APP_CLIENT_SECRET</code></td><td style="text-align: left;">the github app Client Secret</td></tr><tr><td style="text-align: left;"><code class="inline">GITHUB_CERT</code></td><td style="text-align: left;">the github app private key (Base 64 encoded)</td></tr></tbody></table><p>You can access these from your github app settings menu. Also needed for the
configuration is:</p><ul><li><code class="inline">REPO_CONNECTION_SIGNING_SECRET</code> - secret used to sign access tokens. This
access token is used to authenticate requests made from the github actions.
You can generate this using <a href="Mix.Tasks.Lightning.GenEncryptionKey.html"><code class="inline">mix lightning.gen_encryption_key</code></a></li></ul><h3 id="storage" class="section-heading"><a href="#storage" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Storage</span></h3><p>Lightning can use a storage backend to store exports.</p><table><thead><tr><th style="text-align: left;"><strong>Variable</strong></th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">STORAGE_BACKEND</code></td><td style="text-align: left;">the storage backend to use. (default is <code class="inline">local</code>)</td></tr><tr><td style="text-align: left;"><code class="inline">STORAGE_PATH</code></td><td style="text-align: left;">the path to store files in. (default is <code class="inline">.</code>)</td></tr></tbody></table><h4>Supported backends:</h4><ul><li><code class="inline">local</code> - local file storage</li><li><code class="inline">gcs</code> - Google Cloud Storage</li></ul><h4>Google Cloud Storage</h4><p>For Google Cloud Storage, the following environment variables are required:</p><table><thead><tr><th style="text-align: left;"><strong>Variable</strong></th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">GCS_BUCKET</code></td><td style="text-align: left;">the name of the bucket to store files in</td></tr><tr><td style="text-align: left;"><code class="inline">GOOGLE_APPLICATION_CREDENTIALS_JSON</code></td><td style="text-align: left;">A base64 encoded JSON keyfile for the service account with access to the bucket.</td></tr></tbody></table><blockquote><p>‚ÑπÔ∏è Note: The <code class="inline">GOOGLE_APPLICATION_CREDENTIALS_JSON</code> should be base64 encoded,
currently Workload Identity is not supported.</p></blockquote><h3 id="mail" class="section-heading"><a href="#mail" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Mail</span></h3><p>Lightning can send emails for various reasons, such as password resets and
alerts for failed runs.</p><p>In order to send emails, you need to set the <code class="inline">MAIL_PROVIDER</code> environment
variable to one of the following:</p><ul><li><code class="inline">local</code> (the default)</li><li><code class="inline">mailgun</code></li><li><code class="inline">smtp</code></li></ul><p>You will also want to set the <code class="inline">EMAIL_ADMIN</code> environment variable to the email
address that will be used as the sender for system emails.</p><h4>Mailgun</h4><p>For mailgun, the following environment variables are required:</p><table><thead><tr><th style="text-align: left;"><strong>Variable</strong></th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">MAIL_PROVIDER</code></td><td style="text-align: left;">Must be set to <code class="inline">mailgun</code></td></tr><tr><td style="text-align: left;"><code class="inline">MAILGUN_API_KEY</code></td><td style="text-align: left;">the mail gun api key</td></tr><tr><td style="text-align: left;"><code class="inline">MAILGUN_DOMAIN</code></td><td style="text-align: left;">the mail gun domain</td></tr></tbody></table><h4>SMTP</h4><p>For SMTP, the following environment variables are required:</p><table><thead><tr><th style="text-align: left;"><strong>Variable</strong></th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">MAIL_PROVIDER</code></td><td style="text-align: left;">Must be set to <code class="inline">smtp</code></td></tr><tr><td style="text-align: left;"><code class="inline">SMTP_USERNAME</code></td><td style="text-align: left;">Username for your server</td></tr><tr><td style="text-align: left;"><code class="inline">SMTP_PASSWORD</code></td><td style="text-align: left;">Password for the user</td></tr><tr><td style="text-align: left;"><code class="inline">SMTP_RELAY</code></td><td style="text-align: left;">IP address or hostname</td></tr><tr><td style="text-align: left;"><code class="inline">SMTP_TLS</code></td><td style="text-align: left;">Use TLS, defaults to <code class="inline">true</code>, options are <code class="inline">true</code>, <code class="inline">false</code>, <code class="inline">if_available</code></td></tr><tr><td style="text-align: left;"><code class="inline">SMTP_PORT</code></td><td style="text-align: left;">Which port to use, defaults to <code class="inline">587</code></td></tr></tbody></table><h3 id="other-config" class="section-heading"><a href="#other-config" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Other config</span></h3><table><thead><tr><th style="text-align: left;"><strong>Variable</strong></th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">ADAPTORS_PATH</code></td><td style="text-align: left;">Where you store your locally installed adaptors</td></tr><tr><td style="text-align: left;"><code class="inline">ALLOW_SIGNUP</code></td><td style="text-align: left;">Set to <code class="inline">true</code> to enable user access to the registration page. Set to <code class="inline">false</code> to disable new user registrations and block access to the registration page.&lt;br&gt;Default is <code class="inline">true</code>.</td></tr><tr><td style="text-align: left;"><code class="inline">CORS_ORIGIN</code></td><td style="text-align: left;">A list of acceptable hosts for browser/cors requests (',' separated)</td></tr><tr><td style="text-align: left;"><code class="inline">DISABLE_DB_SSL</code></td><td style="text-align: left;">In production, the use of an SSL connection to Postgres is required by default.&lt;br&gt;Setting this to <code class="inline">&quot;true&quot;</code> allows unencrypted connections to the database. This is strongly discouraged in a real production environment.</td></tr><tr><td style="text-align: left;"><code class="inline">EMAIL_ADMIN</code></td><td style="text-align: left;">This is used as the sender email address for system emails. It is also displayed in the menu as the support email.</td></tr><tr><td style="text-align: left;"><code class="inline">EMAIL_SENDER_NAME</code></td><td style="text-align: left;">This is displayed in the email client as the sender name for emails sent by the application.</td></tr><tr><td style="text-align: left;"><code class="inline">ERLANG_NODE_DISCOVERY_VIA_POSTGRES_CHANNEL_NAME</code></td><td style="text-align: left;">The name of the Postgresql channel that is used when Erlang node discovery via Postgres is enabled. Defaults to <code class="inline">lightning-cluster</code> if not set.</td></tr><tr><td style="text-align: left;"><code class="inline">ERLANG_NODE_DISCOVERY_VIA_POSTGRES_ENABLED</code></td><td style="text-align: left;">If set to <code class="inline">true</code>, Lightning will use Postgres to discover Erlang nodes. This strategy will be used in addition to other strategies that are in use. Default value is <code class="inline">false</code></td></tr><tr><td style="text-align: left;"><code class="inline">IDLE_TIMEOUT</code></td><td style="text-align: left;">The number of seconds that must pass without data being received before the Lightning web server kills the connection.</td></tr><tr><td style="text-align: left;"><code class="inline">IS_RESETTABLE_DEMO</code></td><td style="text-align: left;">If set to <code class="inline">yes</code>, it allows this instance to be reset to the initial &quot;Lightning Demo&quot; state. Note that this will destroy <em>most</em> of what you have in your database!</td></tr><tr><td style="text-align: left;"><code class="inline">K8S_HEADLESS_SERVICE</code></td><td style="text-align: left;">This environment variable is automatically set if you're running on GKE and it is used to establish an Erlang node cluster. Note that if you're <em>not</em> using Kubernetes, the &quot;gossip&quot; strategy is used to establish clusters.</td></tr><tr><td style="text-align: left;"><code class="inline">LISTEN_ADDRESS</code></td><td style="text-align: left;">The address the web server should bind to. Defaults to <code class="inline">127.0.0.1</code> to block access from other machines.</td></tr><tr><td style="text-align: left;"><code class="inline">LOG_LEVEL</code></td><td style="text-align: left;">How noisy you want the logs to be (e.g., <code class="inline">debug</code>, <code class="inline">info</code>)</td></tr><tr><td style="text-align: left;"><code class="inline">METRICS_RUN_PERFORMANCE_AGE_SECONDS</code></td><td style="text-align: left;">The oldest a run can be to be included in Run performance metrics.</td></tr><tr><td style="text-align: left;"><code class="inline">METRICS_RUN_QUEUE_AGE_SECONDS</code></td><td style="text-align: left;">The polling period for run queue metrics.</td></tr><tr><td style="text-align: left;"><code class="inline">METRICS_STALLED_RUN_THRESHOLD_SECONDS</code></td><td style="text-align: left;">The length of time a Run must be in the <code class="inline">available</code> state before it is considered stalled.</td></tr><tr><td style="text-align: left;"><code class="inline">METRICS_UNCLAIMED_RUN_THRESHOLD_SECONDS</code></td><td style="text-align: left;">The length of time a Run must be in the <code class="inline">available</code> state before it counts towards an impeded project.</td></tr><tr><td style="text-align: left;"><code class="inline">MIX_ENV</code></td><td style="text-align: left;">Your mix env, likely <code class="inline">prod</code> for deployment</td></tr><tr><td style="text-align: left;"><code class="inline">NODE_ENV</code></td><td style="text-align: left;">Node env, likely <code class="inline">production</code> for deployment</td></tr><tr><td style="text-align: left;"><code class="inline">ORIGINS</code></td><td style="text-align: left;">The allowed origins for web traffic to the backend</td></tr><tr><td style="text-align: left;"><code class="inline">PER_WORKFLOW_CLAIM_LIMIT</code></td><td style="text-align: left;">The maximum number of runs per workflow to consider during run claiming. This prevents any single workflow from dominating the processing queue while ensuring fairness across workflows.&lt;br&gt;Default is <code class="inline">50</code>.</td></tr><tr><td style="text-align: left;"><code class="inline">PORT</code></td><td style="text-align: left;">The port your Phoenix app runs on</td></tr><tr><td style="text-align: left;"><code class="inline">PROMEX_DATASOURCE_ID</code></td><td style="text-align: left;">The datasource that PromEx will use if configured to push initial dashboards to Grafana. Defaults to an empty string.</td></tr><tr><td style="text-align: left;"><code class="inline">PROMEX_ENABLED</code></td><td style="text-align: left;">Enables PromEx tracking and publishing of metrics if set to 'true' or 'yes'. Defaults to false.</td></tr><tr><td style="text-align: left;"><code class="inline">PROMEX_ENDPOINT_SCHEME</code></td><td style="text-align: left;">The scheme needed when connecting to the Promex Endpoint. Defaults to https.</td></tr><tr><td style="text-align: left;"><code class="inline">PROMEX_EXPENSIVE_METRICS_ENABLED</code></td><td style="text-align: left;">Certain metrics may be expensive to generate if Lightning is under load. If set to 'true', or 'yes' these metrics will be enabled. Defaults to 'false'.</td></tr><tr><td style="text-align: left;"><code class="inline">PROMEX_GRAFANA_HOST</code></td><td style="text-align: left;">This is used when PromEx is required to push data to a Grafana instance, e.g. when PromEx sets up initial dashboards.</td></tr><tr><td style="text-align: left;"><code class="inline">PROMEX_GRAFANA_PASSWORD</code></td><td style="text-align: left;">This is used when PromEx is required to push data to a Grafana instance, e.g. when PromEx sets up initial dashboards.</td></tr><tr><td style="text-align: left;"><code class="inline">PROMEX_GRAFANA_USER</code></td><td style="text-align: left;">This is used when PromEx is required to push data to a Grafana instance, e.g. when PromEx sets up initial dashboards.</td></tr><tr><td style="text-align: left;"><code class="inline">PROMEX_METRICS_ENDPOINT_AUTHORIZATION_REQUIRED</code></td><td style="text-align: left;">If set to 'true' or 'yes', the PromEx endpoint on Lightning will require consumers to provide credentials for authorization. Defaults to 'true'.</td></tr><tr><td style="text-align: left;"><code class="inline">PROMEX_METRICS_ENDPOINT_TOKEN</code></td><td style="text-align: left;">A Bearer token that the consumer of the promEx endpoint must provide in the Authorization header. Defaults to a random series of bytes.</td></tr><tr><td style="text-align: left;"><code class="inline">PROMEX_UPLOAD_GRAFANA_DASHBOARDS_ON_START</code></td><td style="text-align: left;">Instructs PromEx to upload iniital dashboards to a Grafana instance if set to 'true' or 'yes'. Defaults to false.</td></tr><tr><td style="text-align: left;"><code class="inline">PRIMARY_ENCRYPTION_KEY</code></td><td style="text-align: left;">A base64 encoded 32 character long string.&lt;br&gt;See <a href="#encryption">Encryption</a>.</td></tr><tr><td style="text-align: left;"><code class="inline">QUEUE_RESULT_RETENTION_PERIOD_MINUTES</code></td><td style="text-align: left;">The number of minutes to keep completed (successful) <code class="inline">ObanJobs</code> in the queue (not to be confused with runs and/or history)</td></tr><tr><td style="text-align: left;"><code class="inline">SCHEMAS_PATH</code></td><td style="text-align: left;">Path to the credential schemas that provide forms for different adaptors</td></tr><tr><td style="text-align: left;"><code class="inline">ADAPTORS_REGISTRY_JSON_PATH</code></td><td style="text-align: left;">Path to adaptor registry file. When provided, the app will attempt to read from it then later fallback to the internet</td></tr><tr><td style="text-align: left;"><code class="inline">SECRET_KEY_BASE</code></td><td style="text-align: left;">A secret key used as a base to generate secrets for encrypting and signing data.</td></tr><tr><td style="text-align: left;"><code class="inline">SENTRY_DSN</code></td><td style="text-align: left;">If using Sentry for error monitoring, your DSN</td></tr><tr><td style="text-align: left;"><code class="inline">UI_METRICS_ENABLED</code></td><td style="text-align: left;">Enable serverside tracking of certain metrics related to the UI. This s temporary functionality. Defaults to <code class="inline">false</code>.</td></tr><tr><td style="text-align: left;"><code class="inline">URL_HOST</code></td><td style="text-align: left;">The host used for writing URLs (e.g., <code class="inline">demo.openfn.org</code>)</td></tr><tr><td style="text-align: left;"><code class="inline">URL_PORT</code></td><td style="text-align: left;">The port, usually <code class="inline">443</code> for production</td></tr><tr><td style="text-align: left;"><code class="inline">URL_SCHEME</code></td><td style="text-align: left;">The scheme for writing URLs (e.g., <code class="inline">https</code>)</td></tr><tr><td style="text-align: left;"><code class="inline">USAGE_TRACKER_HOST</code></td><td style="text-align: left;">The host that receives usage tracking submissions&lt;br&gt;(defaults to <a href="https://impact.openfn.org">https://impact.openfn.org</a>)</td></tr><tr><td style="text-align: left;"><code class="inline">USAGE_TRACKING_DAILY_BATCH_SIZE</code></td><td style="text-align: left;">The number of days that will be reported on with each run of <code class="inline">UsageTracking.DayWorker</code>. This will only have a noticeable effect in cases where there is a backlog or where reports are being generated retroactively (defaults to 10).</td></tr><tr><td style="text-align: left;"><code class="inline">USAGE_TRACKING_ENABLED</code></td><td style="text-align: left;">Enables the submission of anonymized usage data to OpenFn (defaults to <code class="inline">true</code>)</td></tr><tr><td style="text-align: left;"><code class="inline">USAGE_TRACKING_RESUBMISSION_BATCH_SIZE</code></td><td style="text-align: left;">The number of failed reports that will be submitted on each resubmission run (defaults to 10)</td></tr><tr><td style="text-align: left;"><code class="inline">USAGE_TRACKING_RUN_CHUNK_SIZE</code></td><td style="text-align: left;">The size of each batch of runs that is streamed from the database when generating UsageTracking reports (default 100). Decreasing this may decrease memory consumption when generating reports.</td></tr><tr><td style="text-align: left;"><code class="inline">USAGE_TRACKING_UUIDS</code></td><td style="text-align: left;">Indicates whether submissions should include cleartext UUIDs or not. Options are <code class="inline">cleartext</code> or <code class="inline">hashed_only</code>, with the default being <code class="inline">hashed_only</code>.</td></tr><tr><td style="text-align: left;"><code class="inline">REQUIRE_EMAIL_VERIFICATION</code></td><td style="text-align: left;">Indicates whether user email addresses should be verified. Defaults to <code class="inline">false</code>.</td></tr></tbody></table><h3 id="ai-chat" class="section-heading"><a href="#ai-chat" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">AI Chat</span></h3><p>üß™ <strong>Experimental</strong></p><p>Lightning can be configured to use an AI chatbot for user interactions.</p><p>See <a href="https://github.com/OpenFn/apollo">openfn/apollo</a> for more information on
the Apollo AI service.</p><p>The following environment variables are required:</p><ul><li><code class="inline">AI_ASSISTANT_API_KEY</code> - API key to use the assistant. This currently requires
an Anthropic key.</li><li><code class="inline">APOLLO_ENDPOINT</code> - the endpoint for the OpenFn Apollo AI service.</li></ul><h3 id="kafka-triggers" class="section-heading"><a href="#kafka-triggers" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Kafka Triggers</span></h3><p>üß™ <strong>Experimental</strong></p><p>Lightning workflows can be configured with a trigger that will consume messages
from a Kafka Cluster. By default this is disabled and you will not see the
option to create a Kafka trigger in the UI, nor will the Kafka consumer groups
be running.</p><p>To enable this feature set the <code class="inline">KAFKA_TRIGGERS_ENABLED</code> environment variable to
<code class="inline">yes</code> and restart Lightning. Please note that, if you enable this feature and
then create some Kafka triggers and then disable the feature, you will not be
able to edit any triggers created before the feature was disabled.</p><h4>Performance Tuning</h4><p>The number of Kafka consumers in the consumer group can be modified by setting
the <code class="inline">KAFKA_NUMBER_OF_CONSUMERS</code> environment variable. The default value is
currently 1. The optimal setting is one consumer per topic partition. NOTE: This
setting will move to KafkaConfiguration as it will be trigger-specific.</p><p>The number of messages that the Kafka consumer will forward is rate-limited by
the <code class="inline">KAFKA_NUMBER_OF_MESSAGES_PER_SECOND</code> environment variable. This can be set
to a value of less than 1 (minimum 0.1) and will converted (and rounded-down) to
an integer value of messages over a 10-second interval (e.g. 0.15 becomes 1
message every 10 seconds). The default value is 1.</p><p>Processing concurrency within the Kafka Broadway pipeline is controlled by the
<code class="inline">KAFKA_NUMBER_OF_PROCESSORS</code> environment variable. Modifying this, modifies the
number of processors that are downstream of the Kafka consumer, so an increase
in this value should increase throughput (when factoring in the rate limit set
by <code class="inline">KAFKA_NUMBER_OF_MESSAGES_PER_SECOND</code>). The default value is 1.</p><h4>Deduplication</h4><p>Each Kafka trigger maintains record of the topic, partition and offset for each
message received. This to protect against the ingestion of duplicate messages
from the cluster. These records are periodically cleaned out. The duration for
which they are retained is controlled by
<code class="inline">KAFKA_DUPLICATE_TRACKING_RETENTION_SECONDS</code>. The default value is 3600.</p><h4>Disabling Kafka Triggers</h4><p>After a Kafka consumer group connects to a Kafka cluster, the cluster will track
the last committed offset for a given consumer group ,to ensure that the
consumer group receives the correct messages.</p><p>This data is retained for a finite period. If an enabled Kafka trigger is
disabled for longer than the offset retention period the consumer group offset
data will be cleared.</p><p>If the Kafka trigger is re-enabled after the offset data has been cleared, this
will result in the consumer group reverting to what has been configured as the
'Initial offset reset policy' for the trigger. This may result in the
duplication of messages or even data loss.</p><p>It is recommended that you check the value of the <code class="inline">offsets.retention.minutes</code>
for the Kafka cluster to determine what the cluster's retention period is, and
consider this when disabling a Kafka trigger for an extended period.</p><h4>Failure notifications</h4><p>Under certain failure conditions, a Kafka trigger will send an email to certain
users that are associated with a project. After each email an embargo is applied
to ensure that Lightning does not flood the recipients with email. The length of
the embargo is controlled by the <code class="inline">KAFKA_NOTIFICATION_EMBARGO_SECONDS</code> ENV
variable.</p><h4>Persisting Failed Messages</h4><p><strong>PLEASE NOTE: If alternate file storage is not enabled, messages that fail to
be persisted will not be retained by Lightning and this can result in data loss,
if the Kafka cluster can not make these messages available again.</strong></p><p>If a Kafka message fails to be persisted as a WorkOrder, Run and Dataclip, the
option exists to write the failed message to a location on the local file
system. If this option is enabled by setting <code class="inline">KAFKA_ALTERNATE_STORAGE_ENABLED</code>,
then the <code class="inline">KAFKA_ALTERNATE_STORAGE_PATH</code> ENV variable must be set to the path
that exists and is writable by Lightning. The location should also be suitably
protected to prevent data exposure as Lightning <strong>will not encrypt</strong> the message
contents when writing it.</p><p>If the option is enabled and a message fails to be persisted, Lightning will
create a subdirectory named with the id if the affected trigger's workflow in
the location specified by <code class="inline">KAFKA_ALTERNATE_STORAGE_PATH</code> (assuming such a
subdirectory does not already exist). Lightning will serialise the message
headers and data as received by the Kafka pipeline and write this to a file
within the subdirectory. The file will be named based on the pattern
<code class="inline">&lt;trigger_id&gt;_&lt;message_topic&gt;_&lt;message_partition&gt;_&lt;message_offset&gt;.json</code>.</p><p>To recover the persisted messages, it is suggested that the affected triggers be
disabled before commencing. Once this is done, the following code needs to be
run from an IEx console on each node that is running Lightning:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Lightning.KafkaTriggers.MessageRecovery</span><span class="o">.</span><span class="n">recover_messages</span><span class="p" data-group-id="7335718503-1">(</span><span class="w">
  </span><span class="nc">Lightning.Config</span><span class="o">.</span><span class="n">kafka_alternate_storage_file_path</span><span class="p" data-group-id="7335718503-2">(</span><span class="p" data-group-id="7335718503-2">)</span><span class="w">
</span><span class="p" data-group-id="7335718503-1">)</span></code></pre><p>Further details regarding the behaviour of <code class="inline">MessageRecovery.recover_messages/1</code>
can be found in the module documentation of <code class="inline">MessageRecovery</code>. Recovered
messages will have the <code class="inline">.json</code> extension modified to <code class="inline">.json.recovered</code> but they
will be left in place. Future recovery runs will not process files that have
been marked as recovered.</p><p>Once all files have either been recovered or discarded, the triggers can be
enabled once more.</p><h3 id="google-oauth2" class="section-heading"><a href="#google-oauth2" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Google Oauth2</span></h3><p>Using your Google Cloud account, provision a new OAuth 2.0 Client with the 'Web
application' type.</p><p>Set the callback url to: <code class="inline">https://&lt;ENDPOINT DOMAIN&gt;/authenticate/callback</code>.
Replacing <code class="inline">ENDPOINT DOMAIN</code> with the host name of your instance.</p><p>Once the client has been created, get/download the OAuth client JSON and set the
following environment variables:</p><table><thead><tr><th style="text-align: left;"><strong>Variable</strong></th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">GOOGLE_CLIENT_ID</code></td><td style="text-align: left;">Which is <code class="inline">client_id</code> from the client details.</td></tr><tr><td style="text-align: left;"><code class="inline">GOOGLE_CLIENT_SECRET</code></td><td style="text-align: left;"><code class="inline">client_secret</code> from the client details.</td></tr></tbody></table><h3 id="salesforce-oauth2" class="section-heading"><a href="#salesforce-oauth2" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Salesforce Oauth2</span></h3><p>Using your Salesforce developer account, create a new Oauth 2.0 connected
application.</p><p>Set the callback url to: <code class="inline">https://&lt;ENDPOINT DOMAIN&gt;/authenticate/callback</code>.
Replacing <code class="inline">ENDPOINT DOMAIN</code> with the host name of your instance.</p><p>Grant permissions as desired.</p><p>Once the client has been created set the following environment variables:</p><table><thead><tr><th style="text-align: left;"><strong>Variable</strong></th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">SALESFORCE_CLIENT_ID</code></td><td style="text-align: left;">Which is <code class="inline">Consumer Key</code> from the &quot;Manage Consumer Details&quot; screen.</td></tr><tr><td style="text-align: left;"><code class="inline">SALESFORCE_CLIENT_SECRET</code></td><td style="text-align: left;">Which is <code class="inline">Consumer Secret</code> from the &quot;Manage Consumer Details&quot; screen.</td></tr></tbody></table><h3 id="webhook-retry-configuration" class="section-heading"><a href="#webhook-retry-configuration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Webhook Retry Configuration</span></h3><p>Lightning automatically retries webhook processing on <strong>transient database
connection errors</strong> using exponential backoff. This helps prevent data loss
during brief database outages.</p><p>The following environment variables control webhook retry behavior:</p><table><thead><tr><th style="text-align: left;"><strong>Variable</strong></th><th style="text-align: left;"><strong>Description</strong></th><th style="text-align: right;"><strong>Default</strong></th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">WEBHOOK_RETRY_MAX_ATTEMPTS</code></td><td style="text-align: left;">Maximum number of attempts (the first attempt runs immediately; backoffs occur between retries).</td><td style="text-align: right;"><code class="inline">5</code></td></tr><tr><td style="text-align: left;"><code class="inline">WEBHOOK_RETRY_INITIAL_DELAY_MS</code></td><td style="text-align: left;">Initial backoff delay in milliseconds.</td><td style="text-align: right;"><code class="inline">100</code></td></tr><tr><td style="text-align: left;"><code class="inline">WEBHOOK_RETRY_MAX_DELAY_MS</code></td><td style="text-align: left;">Maximum backoff delay in milliseconds.</td><td style="text-align: right;"><code class="inline">10000</code></td></tr><tr><td style="text-align: left;"><code class="inline">WEBHOOK_RETRY_BACKOFF_FACTOR</code></td><td style="text-align: left;">Multiplier for exponential backoff (each delay √ó this factor, up to the max delay).</td><td style="text-align: right;"><code class="inline">2</code></td></tr><tr><td style="text-align: left;"><code class="inline">WEBHOOK_RETRY_TIMEOUT_MS</code></td><td style="text-align: left;">Total time budget for all attempts (including sleeps) in milliseconds.</td><td style="text-align: right;"><code class="inline">60000</code></td></tr><tr><td style="text-align: left;"><code class="inline">WEBHOOK_RETRY_JITTER</code></td><td style="text-align: left;">Whether to add \~0‚Äì25% randomization to each delay to avoid thundering herd (<code class="inline">true</code>/<code class="inline">false</code>).</td><td style="text-align: right;"><code class="inline">true</code></td></tr></tbody></table><p><strong>How backoff works (defaults, jitter off):</strong> attempt 1 runs immediately; on
failure we sleep and retry up to <code class="inline">WEBHOOK_RETRY_MAX_ATTEMPTS - 1</code> times with
exponential delays starting at <code class="inline">WEBHOOK_RETRY_INITIAL_DELAY_MS</code> and multiplying
by <code class="inline">WEBHOOK_RETRY_BACKOFF_FACTOR</code>, capped by <code class="inline">WEBHOOK_RETRY_MAX_DELAY_MS</code>.
Example sequence: <code class="inline">100ms ‚Üí 200ms ‚Üí 400ms ‚Üí 800ms</code> (four sleeps for five total
attempts), stopping sooner if <code class="inline">WEBHOOK_RETRY_TIMEOUT_MS</code> elapses.</p><p><strong>Server timeout alignment:</strong> Set your Phoenix <code class="inline">IDLE_TIMEOUT</code> to be <strong>at least</strong>
<code class="inline">WEBHOOK_RETRY_TIMEOUT_MS + 15000</code> (in milliseconds) so long retries finish
before the connection is closed.</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="runninglocal.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ‚Üê Previous Page
        </span>
        <span class="title">
Running Locally
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="benchmarking.md.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page ‚Üí
        </span>
        <span class="title">
Benchmarking
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="Lightning.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.4) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
