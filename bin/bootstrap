#!/usr/bin/env bash
# This script installs all dependencies required to setup Lightning for development.

set -euo pipefail

trap 'echo "âŒ Script interrupted at line $LINENO"; exit 1' ERR INT

# Global environment facts (no declare -g needed at global scope)
OS=""
ARCH=""
HAS_RUST=""
HAS_HOMEBREW=""
HOMEBREW_PACKAGES_INSTALLED=""
# Use regular arrays instead of associative arrays
MISSING_SYSTEM_DEPS=()
MISSING_BREW_PACKAGES=()

# Function to gather environment facts
gather_environment_facts() {
  echo "ğŸ” Gathering environment information..."

  # System information
  OS="$(uname)"
  ARCH="$(uname -m)"
  echo "Platform: $OS $ARCH"

  # Check system commands
  if command -v node &>/dev/null; then
    echo "âœ… Node.js: $(node --version)"
  else
    MISSING_SYSTEM_DEPS+=("Node.js")
  fi

  if command -v elixir &>/dev/null; then
    local elixir_version
    elixir_version="$(elixir --version 2>/dev/null | head -1 || echo "version unknown")"
    echo "âœ… Elixir: $elixir_version"
  else
    MISSING_SYSTEM_DEPS+=("Elixir")
  fi

  if command -v rustc &>/dev/null; then
    HAS_RUST=true
    echo "âœ… Rust: $(rustc --version)"
  else
    HAS_RUST=false
    MISSING_BREW_PACKAGES+=("rust")
  fi

  # Check Homebrew availability
  if command -v brew &>/dev/null; then
    HAS_HOMEBREW=true
    echo "âœ… Homebrew: $(brew --version | head -1)"

    # Get installed packages once
    HOMEBREW_PACKAGES_INSTALLED="$(brew list -1 2>/dev/null || true)"
  else
    HAS_HOMEBREW=false
  fi

  # Check Homebrew packages if available
  if [[ "$HAS_HOMEBREW" == true ]]; then
    local required_brew_packages
    required_brew_packages=(libsodium cmake)

    for package in "${required_brew_packages[@]}"; do
      if echo "$HOMEBREW_PACKAGES_INSTALLED" | grep -q "^$package$"; then
        echo "âœ… $package (via Homebrew)"
      else
        MISSING_BREW_PACKAGES+=("$package")
      fi
    done

    # Add rust to missing brew packages if not installed via system
    if [[ "$HAS_RUST" == false ]]; then
      if echo "$HOMEBREW_PACKAGES_INSTALLED" | grep -q "^rust$"; then
        echo "âœ… Rust (via Homebrew)"
        # Remove rust from missing packages (need to rebuild array)
        local new_missing=()
        for pkg in "${MISSING_BREW_PACKAGES[@]}"; do
          if [[ "$pkg" != "rust" ]]; then
            new_missing+=("$pkg")
          fi
        done
        MISSING_BREW_PACKAGES=("${new_missing[@]}")
      fi
    fi
  fi

  echo ""
}

# Function to display environment status and exit if critical dependencies missing
check_environment_status() {
  echo "ğŸ“‹ Environment Status Summary:"

  local has_critical_missing=false
  local has_installable_missing=false

  # Check critical system dependencies
  if [[ ${#MISSING_SYSTEM_DEPS[@]} -gt 0 ]]; then
    echo "âŒ Missing critical system dependencies:"
    for dep in "${MISSING_SYSTEM_DEPS[@]}"; do
      echo "   - $dep"
    done
    has_critical_missing=true
  fi

  # Check installable homebrew dependencies
  if [[ ${#MISSING_BREW_PACKAGES[@]} -gt 0 ]]; then
    if [[ "$HAS_HOMEBREW" == true ]]; then
      echo "ğŸ“¦ Missing Homebrew packages (will install):"
      for package in "${MISSING_BREW_PACKAGES[@]}"; do
        echo "   - $package"
      done
      has_installable_missing=true
    else
      echo "âŒ Homebrew not available, cannot install:"
      for package in "${MISSING_BREW_PACKAGES[@]}"; do
        echo "   - $package"
      done
      has_critical_missing=true
    fi
  fi

  # Exit if critical dependencies missing
  if [[ "$has_critical_missing" == true ]]; then
    echo ""
    echo "âŒ Critical dependencies are missing. Please install them manually and re-run this script."
    exit 1
  fi

  if [[ "$has_installable_missing" == false ]]; then
    echo "âœ… All dependencies are satisfied"
  fi

  echo ""
}

# Function to install missing homebrew packages
install_missing_homebrew_packages() {
  if [[ ${#MISSING_BREW_PACKAGES[@]} -gt 0 ]] && [[ "$HAS_HOMEBREW" == true ]]; then
    echo "ğŸ“¦ Installing missing Homebrew packages: ${MISSING_BREW_PACKAGES[*]}"
    if brew install "${MISSING_BREW_PACKAGES[@]}"; then
      echo "âœ… All missing packages have been installed"
    else
      echo "âŒ Failed to install some packages"
      exit 1
    fi
    echo ""
  fi
}

# Function to set environment variables
setup_environment_variables() {
  if [[ "$OS" == "Darwin" ]]; then
    # Check if libsodium is available (either already installed or just installed)
    if echo "$HOMEBREW_PACKAGES_INSTALLED" | grep -q "^libsodium$" || brew list libsodium &>/dev/null; then
      export CPATH=/opt/homebrew/include
      export LIBRARY_PATH=/opt/homebrew/lib
      echo "ğŸ”§ Set environment variables for libsodium"
    fi
  fi
}

# Main execution flow
main() {
  gather_environment_facts
  check_environment_status
  install_missing_homebrew_packages
  setup_environment_variables

  echo "ğŸ”§ Setting up Elixir environment..."
  mix local.hex --if-missing
  mix local.rebar --if-missing

  echo "ğŸ“¦ Installing Elixir dependencies..."
  mix deps.get
  mix deps.compile

  # If you have already compiled Rambo explicitly via `mix compile.rambo`, and you
  # are still seeing the following error:
  #
  # ```
  # sh: /path_to_directory/Lightning/_build/dev/lib/rambo/priv/rambo: No such file or directory
  # sh: line 0: exec: /path_to_directory/Lightning/_build/dev/lib/rambo/priv/rambo: cannot execute: No such file or directory
  # ```
  #
  # You can try renaming `deps/rambo/priv/rambo-mac` to `deps/rambo/priv/rambo`.

  # Compile platform-specific dependencies
  if [[ "$OS" == "Darwin" && "$ARCH" == "arm64" ]]; then
    echo "ğŸ”¨ Compiling platform-specific dependencies..."
    mix compile.rambo
  fi

  echo "ğŸ“¦ Installing Node.js dependencies..."
  npm install --prefix assets

  echo "ğŸ”§ Setting up assets..."
  mix assets.setup

  echo "ğŸ—„ï¸ Setting up database..."
  mix "do" ecto.create, ecto.migrate

  echo "âš¡ Installing Lightning components..."
  mix lightning.install_runtime
  mix lightning.install_schemas
  mix lightning.install_adaptor_icons

  echo "âœ… All dependencies installed successfully!"
}

main "$@"