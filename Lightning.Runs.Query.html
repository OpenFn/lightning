<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.4">
    <meta name="project" content="Lightning v2.15.2">


    <title>Lightning.Runs.Query â€” Lightning v2.15.2</title>

    <link rel="stylesheet" href="dist/html-elixir-RLZO5U2C.css" />

    <script defer src="dist/sidebar_items-420843F5.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-Y223O6DN.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://openfn.github.io/lightning" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="Lightning" />
        </a>

      <div>
        <a href="https://openfn.github.io/lightning" class="sidebar-projectName" translate="no">
Lightning
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v2.15.2
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-module" id="main" data-type="modules">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of Lightning</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>
      <span translate="no">Lightning.Runs.Query</span> 
      <small class="app-vsn" translate="no">(Lightning v2.15.2)</small>

    </h1>

      <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/runs/query.ex#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


    <section id="moduledoc">
<p>Query functions for working with Runs</p>
    </section>

</div>

  <section id="summary" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#summary">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Summary</span>
    </h1>
<div class="summary-functions summary">
  <h2>
    <a href="#functions">Functions</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#available_within_concurrency_limits/1" data-no-tooltip="" translate="no">available_within_concurrency_limits(in_progress_window_query \\ in_progress_window())</a>

      </div>

        <div class="summary-synopsis"><p>Query to return available runs that respect concurrency limits.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#eligible_for_claim/0" data-no-tooltip="" translate="no">eligible_for_claim()</a>

      </div>

        <div class="summary-synopsis"><p>Query to return runs that are eligible for claiming.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#in_progress_window/0" data-no-tooltip="" translate="no">in_progress_window()</a>

      </div>

        <div class="summary-synopsis"><p>Applies concurrency window functions to workflow-limited run data.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#lost/0" data-no-tooltip="" translate="no">lost()</a>

      </div>

        <div class="summary-synopsis"><p>Return all runs that have been claimed by a worker before the earliest
acceptable start time (determined by the run options and grace period) but are
still incomplete.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#lost_steps/0" data-no-tooltip="" translate="no">lost_steps()</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#workflow_limited_runs/1" data-no-tooltip="" translate="no">workflow_limited_runs(per_workflow_limit \\ 50)</a>

      </div>

        <div class="summary-synopsis"><p>Query to return workflow-limited runs with priority-based ranking.</p></div>

    </div>

</div>

  </section>


  <section id="functions" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#functions">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Functions</span>
    </h1>

    <div class="functions-list">
<section class="detail" id="available_within_concurrency_limits/1">

    <span id="available_within_concurrency_limits/0"></span>

  <div class="detail-header">
    <a href="#available_within_concurrency_limits/1" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">available_within_concurrency_limits(in_progress_window_query \\ in_progress_window())</h1>


        <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/runs/query.ex#L202" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

<p>Query to return available runs that respect concurrency limits.</p><p>This function combines run state filtering with concurrency enforcement by:</p><ol><li>Joining runs with their windowed concurrency data from <a href="#in_progress_window/0"><code class="inline">in_progress_window/0</code></a></li><li>Filtering for runs in <code class="inline">:available</code> state only</li><li>Ensuring runs don't exceed their concurrency limits (workflow or project level)</li><li>Ordering by priority and insertion time for fair processing</li></ol><h2 id="available_within_concurrency_limits/1-concurrency-logic" class="section-heading"><a href="#available_within_concurrency_limits/1-concurrency-logic" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Concurrency Logic</span></h2><p>A run is included if:</p><ul><li>It's in <code class="inline">:available</code> state (not claimed, started, or finished)</li><li>Either no concurrency limit is set (<code class="inline">concurrency</code> is nil) OR</li><li>The run's position within its concurrency group (<code class="inline">row_number</code>) is within the limit</li></ul><p>Returns run IDs that can be safely claimed without violating concurrency constraints.</p>
  </section>
</section>
<section class="detail" id="eligible_for_claim/0">

  <div class="detail-header">
    <a href="#eligible_for_claim/0" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">eligible_for_claim()</h1>


        <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/runs/query.ex#L176" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@spec</span> eligible_for_claim() :: <a href="https://hexdocs.pm/ecto/3.13.2/Ecto.Queryable.html#t:t/0">Ecto.Queryable.t</a>()</pre>

      </div>

<p>Query to return runs that are eligible for claiming.</p><p>This is the main function used by other parts of the system to get runs ready
for execution. It implements a performance-optimized approach to run claiming
that ensures fairness across workflows while respecting concurrency limits.</p><h2 id="eligible_for_claim/0-algorithm" class="section-heading"><a href="#eligible_for_claim/0-algorithm" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Algorithm</span></h2><ol><li><strong>Workflow Limiting</strong>: Limits the number of runs per workflow to prevent any
single workflow from dominating the processing queue</li><li><strong>Window Processing</strong>: Applies row numbering within concurrency partitions
(workflow or project level) on the workflow-limited dataset</li><li><strong>Concurrency Enforcement</strong>: Uses the row numbers to enforce concurrency
limits during run claiming</li><li><strong>Availability Filtering</strong>: Filters for available runs within concurrency limits</li><li><strong>Priority Ordering</strong>: Orders results by priority and insertion time</li></ol><h2 id="eligible_for_claim/0-implementation" class="section-heading"><a href="#eligible_for_claim/0-implementation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Implementation</span></h2><p>The function uses a multi-step approach for performance optimization:</p><ol><li><strong>Pre-filtering</strong>: Uses <a href="#workflow_limited_runs/1"><code class="inline">workflow_limited_runs/1</code></a> to limit runs per workflow
(configurable via <code class="inline">:per_workflow_claim_limit</code>) preventing any single workflow
from dominating the claim queue while ensuring fairness</li><li><strong>Window Functions</strong>: Applies <a href="#in_progress_window/0"><code class="inline">in_progress_window/0</code></a> to calculate row numbers
within concurrency partitions on the smaller, pre-filtered dataset</li><li><strong>Final Filtering</strong>: Selects only available runs that fall within their
concurrency limits (where <code class="inline">row_number &lt;= concurrency</code>)</li></ol><h2 id="eligible_for_claim/0-concurrency-logic" class="section-heading"><a href="#eligible_for_claim/0-concurrency-logic" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Concurrency Logic</span></h2><p>Workflow concurrency takes precedence over project concurrency when both are set.
This ensures that workflow-level limits are respected first, with project-level
limits serving as a fallback.</p><h2 id="eligible_for_claim/0-performance-notes" class="section-heading"><a href="#eligible_for_claim/0-performance-notes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Performance Notes</span></h2><p>The dataset is first limited per workflow (default: 50 runs) to manage the size
of data processed by expensive window functions, significantly improving query
performance on large datasets.</p><section role="note" class="admonition info"><h3 id="eligible_for_claim/0-note" class="admonition-title info section-heading"><a href="#eligible_for_claim/0-note" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Note</span></h3><p>The default <code class="inline">:per_workflow_claim_limit</code> is 50.
This can be configured via the <code class="inline">PER_WORKFLOW_CLAIM_LIMIT</code> environment variable.
The value must be larger than the max concurrency of any individual workflow.</p></section><p>Returns runs ordered by priority and insertion time that can be safely claimed
without violating concurrency limits.</p>
  </section>
</section>
<section class="detail" id="in_progress_window/0">

  <div class="detail-header">
    <a href="#in_progress_window/0" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">in_progress_window()</h1>


        <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/runs/query.ex#L103" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@spec</span> in_progress_window() :: <a href="https://hexdocs.pm/ecto/3.13.2/Ecto.Queryable.html#t:t/0">Ecto.Queryable.t</a>()</pre>

      </div>

<p>Applies concurrency window functions to workflow-limited run data.</p><p>This function takes the output from <a href="#workflow_limited_runs/1"><code class="inline">workflow_limited_runs/1</code></a> and applies
SQL window functions to calculate row numbers within concurrency partitions.</p><h2 id="in_progress_window/0-partitioning-logic" class="section-heading"><a href="#in_progress_window/0-partitioning-logic" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Partitioning Logic</span></h2><p>Runs are partitioned (grouped) by workflow or project for row numbering.
Workflow concurrency takes precedence over project concurrency when both are set.
Within each partition, runs are ordered by priority and insertion time.</p><h2 id="in_progress_window/0-return-fields" class="section-heading"><a href="#in_progress_window/0-return-fields" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Return Fields</span></h2><p>Returns a query that selects:</p><ul><li><code class="inline">id</code> - the run ID</li><li><code class="inline">state</code> - the current state of the run</li><li><code class="inline">row_number</code> - sequential number within the concurrency partition</li><li><code class="inline">project_id</code> - the project ID</li><li><code class="inline">concurrency</code> - the maximum concurrent runs allowed (workflow or project level)</li><li><code class="inline">inserted_at</code> - when the run was created</li><li><code class="inline">priority</code> - the run's priority level</li></ul><p>The <code class="inline">row_number</code> field is used downstream to enforce concurrency limits by
comparing it against the <code class="inline">concurrency</code> value.</p>
  </section>
</section>
<section class="detail" id="lost/0">

  <div class="detail-header">
    <a href="#lost/0" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">lost()</h1>


        <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/runs/query.ex#L21" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@spec</span> lost() :: <a href="https://hexdocs.pm/ecto/3.13.2/Ecto.Queryable.html#t:t/0">Ecto.Queryable.t</a>()</pre>

      </div>

<p>Return all runs that have been claimed by a worker before the earliest
acceptable start time (determined by the run options and grace period) but are
still incomplete.</p><p>This indicates that we may have lost contact with the worker
that was responsible for executing the run.</p>
  </section>
</section>
<section class="detail" id="lost_steps/0">

  <div class="detail-header">
    <a href="#lost_steps/0" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">lost_steps()</h1>


        <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/runs/query.ex#L62" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@spec</span> lost_steps() :: <a href="https://hexdocs.pm/ecto/3.13.2/Ecto.Queryable.html#t:t/0">Ecto.Queryable.t</a>()</pre>

      </div>


  </section>
</section>
<section class="detail" id="workflow_limited_runs/1">

    <span id="workflow_limited_runs/0"></span>

  <div class="detail-header">
    <a href="#workflow_limited_runs/1" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">workflow_limited_runs(per_workflow_limit \\ 50)</h1>


        <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/runs/query.ex#L229" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@spec</span> workflow_limited_runs(<a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">pos_integer</a>()) :: <a href="https://hexdocs.pm/ecto/3.13.2/Ecto.Queryable.html#t:t/0">Ecto.Queryable.t</a>()</pre>

      </div>

<p>Query to return workflow-limited runs with priority-based ranking.</p><p>This function creates a dataset where each workflow contributes at most
<code class="inline">per_workflow_limit</code> runs, ranked by priority and insertion time. This prevents
any single workflow from dominating the claim queue while ensuring fairness.</p><p>Returns runs with workflow ranking information needed for further processing.</p>
  </section>
</section>

    </div>
  </section>

    <footer class="footer">
      <p>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="Lightning.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.4) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
