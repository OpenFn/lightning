<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.4">
    <meta name="project" content="Lightning v2.14.13-pre">


    <title>Lightning.AiAssistant.MessageProcessor — Lightning v2.14.13-pre</title>

    <link rel="stylesheet" href="dist/html-elixir-RLZO5U2C.css" />

    <script defer src="dist/sidebar_items-D1FC9583.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-Y223O6DN.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://openfn.github.io/lightning" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="Lightning" />
        </a>

      <div>
        <a href="https://openfn.github.io/lightning" class="sidebar-projectName" translate="no">
Lightning
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v2.14.13-pre
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-module" id="main" data-type="modules">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of Lightning</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>
      <span translate="no">Lightning.AiAssistant.MessageProcessor</span> 
      <small class="app-vsn" translate="no">(Lightning v2.14.13-pre)</small>

    </h1>

      <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/ai_assistant/message_processor.ex#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


    <section id="moduledoc">
<p>Asynchronous message processor for AI Assistant using Oban.</p><p>This module handles the background processing of AI chat messages, ensuring
reliable and scalable AI interactions. It processes messages outside of the
web request lifecycle, providing better user experience and system resilience.</p>
    </section>

</div>

  <section id="summary" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#summary">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Summary</span>
    </h1>
<div class="summary-functions summary">
  <h2>
    <a href="#functions">Functions</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#handle_ai_assistant_exception/2" data-no-tooltip="" translate="no">handle_ai_assistant_exception(measure, meta)</a>

      </div>

        <div class="summary-synopsis"><p>Handles exceptions for <code class="inline">ai_assistant</code> Oban jobs.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#handle_ai_assistant_stop/2" data-no-tooltip="" translate="no">handle_ai_assistant_stop(measure, meta)</a>

      </div>

        <div class="summary-synopsis"><p>Handles <code class="inline">:stop</code> events for <code class="inline">ai_assistant</code> Oban jobs.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#perform/1" data-no-tooltip="" translate="no">perform(job)</a>

      </div>

        <div class="summary-synopsis"><p>Processes an AI assistant message asynchronously.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#timeout/1" data-no-tooltip="" translate="no">timeout(job)</a>

      </div>

        <div class="summary-synopsis"><p>Defines the job timeout based on Apollo configuration.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#update_message_status/2" data-no-tooltip="" translate="no">update_message_status(message, status)</a>

      </div>

        <div class="summary-synopsis"><p>Updates a message's status and broadcasts the change.</p></div>

    </div>

</div>

  </section>


  <section id="functions" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#functions">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Functions</span>
    </h1>

    <div class="functions-list">
<section class="detail" id="handle_ai_assistant_exception/2">

  <div class="detail-header">
    <a href="#handle_ai_assistant_exception/2" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">handle_ai_assistant_exception(measure, meta)</h1>


        <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/ai_assistant/message_processor.ex#L232" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

<p>Handles exceptions for <code class="inline">ai_assistant</code> Oban jobs.</p><h2 id="handle_ai_assistant_exception/2-parameters" class="section-heading"><a href="#handle_ai_assistant_exception/2-parameters" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Parameters</span></h2><ul><li><code class="inline">measure</code> — A map containing job execution metrics (<code class="inline">duration</code>, <code class="inline">memory</code>, <code class="inline">reductions</code>).</li><li><code class="inline">meta</code> — A map containing job metadata (<code class="inline">job</code>, <code class="inline">error</code>, <code class="inline">stacktrace</code>, etc.).</li></ul>
  </section>
</section>
<section class="detail" id="handle_ai_assistant_stop/2">

  <div class="detail-header">
    <a href="#handle_ai_assistant_stop/2" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">handle_ai_assistant_stop(measure, meta)</h1>


        <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/ai_assistant/message_processor.ex#L309" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

<p>Handles <code class="inline">:stop</code> events for <code class="inline">ai_assistant</code> Oban jobs.</p><p>This function is invoked when a job in the <code class="inline">ai_assistant</code> queue stops with a non-success state
(e.g., <code class="inline">:discard</code>, <code class="inline">:cancelled</code>, or other custom stop reasons).</p><p>Jobs with the <code class="inline">:success</code> state are ignored.</p><h2 id="handle_ai_assistant_stop/2-parameters" class="section-heading"><a href="#handle_ai_assistant_stop/2-parameters" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Parameters</span></h2><ul><li><code class="inline">measure</code> — A map containing job execution metrics (<code class="inline">duration</code>, <code class="inline">memory</code>, <code class="inline">reductions</code>).</li><li><code class="inline">meta</code> — A map containing job metadata (<code class="inline">job</code>, <code class="inline">state</code>, etc.).</li></ul>
  </section>
</section>
<section class="detail" id="perform/1">

  <div class="detail-header">
    <a href="#perform/1" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">perform(job)</h1>


        <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/ai_assistant/message_processor.ex#L40" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@spec</span> perform(<a href="https://hexdocs.pm/oban/2.20.1/Oban.Job.html#t:t/0">Oban.Job.t</a>()) :: :ok</pre>

      </div>

<p>Processes an AI assistant message asynchronously.</p><p>This is the main entry point called by Oban. It handles the complete
lifecycle of message processing including status updates and broadcasting.</p><h2 id="perform/1-arguments" class="section-heading"><a href="#perform/1-arguments" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Arguments</span></h2><ul><li><code class="inline">job</code> - Oban job containing <code class="inline">message_id</code> and <code class="inline">session_id</code> in args</li></ul><h2 id="perform/1-returns" class="section-heading"><a href="#perform/1-returns" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Returns</span></h2><p>Always returns <code class="inline">:ok</code> to prevent Oban retries, even on errors.
Errors are handled by updating message status and logging.</p>
  </section>
</section>
<section class="detail" id="timeout/1">

  <div class="detail-header">
    <a href="#timeout/1" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">timeout(job)</h1>


        <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/ai_assistant/message_processor.ex#L72" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@spec</span> timeout(<a href="https://hexdocs.pm/oban/2.20.1/Oban.Job.html#t:t/0">Oban.Job.t</a>()) :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">pos_integer</a>()</pre>

      </div>

<p>Defines the job timeout based on Apollo configuration.</p><p>Adds a 10-second buffer to the Apollo timeout to account for
network overhead and processing time.</p><h2 id="timeout/1-returns" class="section-heading"><a href="#timeout/1-returns" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Returns</span></h2><p>Timeout in milliseconds</p>
  </section>
</section>
<section class="detail" id="update_message_status/2">

  <div class="detail-header">
    <a href="#update_message_status/2" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">update_message_status(message, status)</h1>


        <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/ai_assistant/message_processor.ex#L175" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@spec</span> update_message_status(
  <a href="Lightning.AiAssistant.ChatMessage.html#t:t/0">Lightning.AiAssistant.ChatMessage.t</a>(),
  <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">atom</a>()
) ::
  {:ok, <a href="Lightning.AiAssistant.ChatSession.html#t:t/0">Lightning.AiAssistant.ChatSession.t</a>(),
   <a href="Lightning.AiAssistant.ChatMessage.html#t:t/0">Lightning.AiAssistant.ChatMessage.t</a>()}</pre>

      </div>

<p>Updates a message's status and broadcasts the change.</p><p>This function updates the message status in the database, fetches the updated
session with all associations, and broadcasts the status change to connected
clients via Phoenix PubSub.</p><h2 id="update_message_status/2-parameters" class="section-heading"><a href="#update_message_status/2-parameters" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Parameters</span></h2><ul><li><code class="inline">message</code> - The <code class="inline">ChatMessage</code> struct to update</li><li><code class="inline">status</code> - The new status atom (<code class="inline">:processing</code>, <code class="inline">:success</code>, or <code class="inline">:error</code>)</li></ul><h2 id="update_message_status/2-returns" class="section-heading"><a href="#update_message_status/2-returns" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Returns</span></h2><p>  <code class="inline">{:ok, updated_session, updated_message}</code> - Tuple with the updated session
  and message structs</p>
  </section>
</section>

    </div>
  </section>

    <footer class="footer">
      <p>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="Lightning.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.4) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
