<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.1">
    <meta name="project" content="Lightning v2.14.4">


    <title>Lightning.Projects.Sandboxes — Lightning v2.14.4</title>

    <link rel="stylesheet" href="dist/html-elixir-J3PIVQVA.css" />

    <script defer src="dist/sidebar_items-81732FA3.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://openfn.github.io/lightning" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="Lightning" />
        </a>

      <div>
        <a href="https://openfn.github.io/lightning" class="sidebar-projectName" translate="no">
Lightning
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v2.14.4
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-module" id="main" data-type="modules">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of Lightning</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>
      <span translate="no">Lightning.Projects.Sandboxes</span> 
      <small class="app-vsn" translate="no">(Lightning v2.14.4)</small>

    </h1>

      <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/projects/sandboxes.ex#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


    <section id="moduledoc">
<p>Provision <strong>sandbox</strong> projects as children of an existing project.</p><p>A sandbox is a full project that:</p><ul><li>clones core <strong>project settings</strong> from the parent,</li><li><strong>references</strong> the same credentials via <code class="inline">project_credentials</code> (no new credentials are created),</li><li>clones the <strong>workflow DAG</strong> (workflows, jobs, triggers, edges),</li><li><strong>disables all triggers</strong> in the sandbox,</li><li><strong>remaps positions</strong> (node coordinates) to the new node IDs,</li><li>copies the <strong>latest</strong> <code class="inline">WorkflowVersion</code> per workflow to seed version history,</li><li>can optionally <strong>copy a subset of named dataclips</strong>,</li><li><strong>clones Keychain credentials (metadata only) actually used by parent jobs</strong> and
rewires sandbox jobs to those cloned keychains, and</li><li>assigns the <strong>creator as :owner</strong>; any <strong>non-owner collaborators</strong> provided are
included <strong>at creation time</strong> (duplicate/owner entries are filtered).</li></ul><h3 id="module-authorization" class="section-heading"><a href="#module-authorization" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Authorization</span></h3><p>The <code class="inline">actor</code> must be <code class="inline">:owner</code> or <code class="inline">:admin</code> on the <strong>parent</strong> project.
Otherwise <code class="inline">{:error, :unauthorized}</code> is returned and nothing is created.</p><h3 id="module-invariants-side-effects" class="section-heading"><a href="#module-invariants-side-effects" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Invariants &amp; side effects</span></h3><ul><li>The sandbox is created in a single DB <strong>transaction</strong>.</li><li>The creator is added as the owner and any <strong>non-owner collaborators</strong> from
<code class="inline">:collaborators</code> are also added at creation time (we ensure exactly one owner).</li><li>Credentials are <strong>not duplicated</strong>; we create <code class="inline">project_credentials</code> rows
that reference the parent’s existing <code class="inline">credentials</code>.</li><li><strong>Keychain credentials are cloned as metadata (name/path/default_credential)</strong> into
the sandbox project; <strong>no secrets are duplicated</strong>. Because we copy
<code class="inline">project_credentials</code> first, the keychain’s <code class="inline">default_credential_id</code> remains valid
in the sandbox and passes validation.</li><li>Trigger rows are cloned but always persisted with <code class="inline">enabled: false</code>.</li><li>Positions are remapped by translating old node IDs to new ones; if no valid
positions remain, we store <code class="inline">nil</code> (UI → auto-layout).</li><li>There are <strong>no runs</strong> or dataclips copied by default.</li></ul><p>See the <a href="#provision/3"><code class="inline">provision/3</code></a> docs below for attribute details and return values.</p>
    </section>

</div>

  <section id="summary" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#summary">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Summary</span>
    </h1>
<div class="summary-types summary">
  <h2>
    <a href="#types">Types</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#t:provision_attrs/0" data-no-tooltip="" translate="no">provision_attrs()</a>

      </div>

        <div class="summary-synopsis"><p>Attributes accepted by <a><code class="inline">provision/3</code></a>.</p></div>

    </div>

</div>
<div class="summary-functions summary">
  <h2>
    <a href="#functions">Functions</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#provision/3" data-no-tooltip="" translate="no">provision(parent, actor, attrs)</a>

      </div>

        <div class="summary-synopsis"><p>Provisions a sandbox project under <code class="inline">parent</code> on behalf of <code class="inline">actor</code>.</p></div>

    </div>

</div>

  </section>


  <section id="types" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#types">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Types</span>
    </h1>
    <div class="types-list">
<section class="detail" id="t:provision_attrs/0">

  <div class="detail-header">
    <a href="#t:provision_attrs/0" class="detail-link" data-no-tooltip="" aria-label="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">provision_attrs()</h1>


        <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/projects/sandboxes.ex#L67" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@type</span> provision_attrs() :: %{
  :name =&gt; <a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>(),
  optional(:color) =&gt; <a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>() | nil,
  optional(:env) =&gt; <a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>() | nil,
  optional(:collaborators) =&gt; [%{user_id: <a href="https://hexdocs.pm/ecto/3.13.2/Ecto.UUID.html#t:t/0">Ecto.UUID.t</a>(), role: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">atom</a>()}],
  optional(:dataclip_ids) =&gt; [<a href="https://hexdocs.pm/ecto/3.13.2/Ecto.UUID.html#t:t/0">Ecto.UUID.t</a>()]
}</pre>

      </div>

<p>Attributes accepted by <a href="#provision/3"><code class="inline">provision/3</code></a>.</p><ul><li><code class="inline">:name</code> (<strong>required</strong>) – sandbox name (scoped unique per <code class="inline">parent_id</code>)</li><li><code class="inline">:color</code> (optional) – UI color string (e.g. <code class="inline">&quot;#336699&quot;</code>)</li><li><code class="inline">:env</code> (optional) – environment slug for the project (e.g. <code class="inline">&quot;staging&quot;</code>)</li><li><code class="inline">:collaborators</code> (optional) – list of <code class="inline">%{user_id: Ecto.UUID.t(), role: atom()}</code>
to add in addition to the creator (owner). Any <code class="inline">:owner</code> entries are ignored
and duplicates by <code class="inline">user_id</code> are removed.</li><li><code class="inline">:dataclip_ids</code> (optional) – list of dataclip IDs to copy <strong>if</strong> they are:<ul><li>named (<code class="inline">name</code> not <code class="inline">nil</code>) <strong>and</strong></li><li>of type in <code class="inline">[:global, :saved_input, :http_request]</code>.</li></ul></li></ul>
  </section>
</section>

    </div>
  </section>

  <section id="functions" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#functions">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Functions</span>
    </h1>
    <div class="functions-list">
<section class="detail" id="provision/3">

  <div class="detail-header">
    <a href="#provision/3" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">provision(parent, actor, attrs)</h1>


        <a href="https://github.com/OpenFn/lightning/blob/main/lib/lightning/projects/sandboxes.ex#L120" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@spec</span> provision(
  <a href="Lightning.Projects.Project.html#t:t/0">Lightning.Projects.Project.t</a>(),
  <a href="Lightning.Accounts.User.html#t:t/0">Lightning.Accounts.User.t</a>(),
  <a href="#t:provision_attrs/0">provision_attrs</a>()
) ::
  {:ok, <a href="Lightning.Projects.Project.html#t:t/0">Lightning.Projects.Project.t</a>()}
  | {:error, :unauthorized | <a href="https://hexdocs.pm/ecto/3.13.2/Ecto.Changeset.html#t:t/0">Ecto.Changeset.t</a>() | <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">term</a>()}</pre>

      </div>

<p>Provisions a sandbox project under <code class="inline">parent</code> on behalf of <code class="inline">actor</code>.</p><p>This function performs the full sandbox provisioning workflow described in the
module documentation. It returns either the newly created sandbox project or
an error tuple without side effects outside the transaction.</p><h2 id="provision/3-parameters" class="section-heading"><a href="#provision/3-parameters" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Parameters</span></h2><ul><li><code class="inline">parent</code> – the parent <code class="inline">%Lightning.Projects.Project{}</code> to clone from</li><li><code class="inline">actor</code> – the <code class="inline">%Lightning.Accounts.User{}</code> performing the action; must be
<code class="inline">:owner</code> or <code class="inline">:admin</code> on the <strong>parent</strong></li><li><code class="inline">attrs</code> – map of attributes (see <a href="#t:provision_attrs/0"><code class="inline">provision_attrs/0</code></a> for details)</li></ul><h2 id="provision/3-returns" class="section-heading"><a href="#provision/3-returns" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Returns</span></h2><ul><li><code class="inline">{:ok, %Lightning.Projects.Project{}}</code> on success</li><li><code class="inline">{:error, :unauthorized}</code> if <code class="inline">actor</code> lacks permission on <code class="inline">parent</code></li><li><p><code class="inline">{:error, Ecto.Changeset.t() | term()}</code> for validation/DB errors</p></li></ul><h2 id="provision/3-what-gets-cloned" class="section-heading"><a href="#provision/3-what-gets-cloned" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">What gets cloned</span></h2><ul><li>Project settings: <code class="inline">allow_support_access</code>, <code class="inline">concurrency</code>, <code class="inline">description</code>,
<code class="inline">requires_mfa</code>, <code class="inline">retention_policy</code>, <code class="inline">history_retention_period</code>,
<code class="inline">dataclip_retention_period</code>.</li><li>Credentials: <code class="inline">project_credentials</code> rows pointing at the <strong>same</strong>
underlying credentials (no new <code class="inline">credentials</code>).</li><li><strong>Keychain credentials (metadata)</strong>: only the keychains actually used by
parent jobs are cloned into the sandbox (<code class="inline">name</code>, <code class="inline">path</code>, <code class="inline">default_credential_id</code>);
sandbox jobs are rewired to those cloned keychains.</li><li>DAG: workflows, jobs, triggers (disabled), edges, webhook auth methods.</li><li>Positions: remapped from parent node IDs to child node IDs; <code class="inline">nil</code> when
nothing remaps (UI → auto-layout).</li><li>Version heads: latest <code class="inline">WorkflowVersion</code> per workflow (<code class="inline">hash</code>, <code class="inline">source</code>).</li></ul>
  </section>
</section>

    </div>
  </section>

    <footer class="footer">
      <p>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="Lightning.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.1) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
