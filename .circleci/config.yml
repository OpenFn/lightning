version: 2.1

orbs:
  codecov: codecov/codecov@1.0.5

# Shared configuration
defaults:
  elixir_version: &elixir_version "1.18.3-otp-27"
  nodejs_version: &nodejs_version "22.12.0"
  docker_elixir: &docker_elixir
    - image: elixir:1.18.3-otp-27
  docker_elixir_postgres: &docker_elixir_postgres
    - image: elixir:1.18.3-otp-27
    - image: cimg/postgres:17.3
  environment: &environment
    ERL_FLAGS: +S 4:4
    ASSERT_RECEIVE_TIMEOUT: 1000
    MIX_ENV: test

executors:
  elixir:
    docker: *docker_elixir
    environment: *environment
    working_directory: /home/lightning/project

  elixir_with_postgres:
    docker: *docker_elixir_postgres
    environment: *environment
    working_directory: /home/lightning/project

commands:
  install_node:
    description: "Install NodeJS from NodeSource"
    parameters:
      version:
        type: string
    steps:
      - run:
          name: "Install Node.js from NodeSource"
          command: |
            NODE_MAJOR=$(echo "<< parameters.version >>" | cut -d'.' -f1)
            curl -fsSL https://deb.nodesource.com/setup_${NODE_MAJOR}.x | bash -
            apt-get install -y nodejs=<< parameters.version >>-1nodesource1

  setup_lightning_user:
    description: "Create lightning user and configure sudo"
    steps:
      - run:
          name: "Create lightning user"
          command: adduser --home /home/lightning --system lightning
      - run:
          name: "Install sudo and configure environment passthrough"
          command: |
            apt-get update && apt-get install -y sudo
            echo 'Defaults env_keep += "ERL_FLAGS ASSERT_RECEIVE_TIMEOUT MIX_ENV"' | \
              sudo EDITOR='tee -a' visudo
      - run:
          name: "Configure git safe directory"
          command: git config --global --add safe.directory /home/lightning/project

  attach_built_workspace:
    description: "Attach workspace and restore ownership"
    steps:
      - attach_workspace:
          at: /home/lightning/project
      - run:
          name: "Restore ownership after workspace attach"
          command: chown -R lightning /home/lightning
      - run:
          name: "Install Hex and Rebar"
          command: sudo -u lightning mix local.hex --force && sudo -u lightning mix local.rebar --force

jobs:
  # ============================================================================
  # COMPILE JOB - Builds everything once, persists to workspace
  # ============================================================================
  compile:
    executor: elixir
    steps:
      - setup_lightning_user
      - checkout
      - run:
          name: "Set ownership"
          command: chown -R lightning /home/lightning
      - install_node:
          version: *nodejs_version

      - run:
          name: "Save Elixir and Erlang version for caching"
          command: echo "$ELIXIR_VERSION $OTP_VERSION" | tee .elixir_otp_version

      - run:
          name: "Introspect schedulers"
          command: elixir -v

      # Restore dependency cache
      - restore_cache:
          keys:
            - v6-deps-{{ arch }}-{{ checksum ".elixir_otp_version" }}-{{ checksum "mix.lock" }}
            - v6-deps-{{ arch }}-{{ checksum ".elixir_otp_version" }}

      - run:
          name: "Install build dependencies"
          command: |
            apt-get update && apt-get install -y \
              build-essential \
              cmake \
              libsodium-dev

      - run:
          name: "Install Hex and Rebar"
          command: sudo -u lightning mix local.hex --force && mix local.rebar --force

      - run:
          name: "Install Node dependencies"
          command: cd assets && sudo -u lightning npm install --force

      - run:
          name: "Compile Elixir dependencies and application"
          command: sudo -u lightning mix do deps.get --only test, deps.compile, compile

      - run:
          name: "Install runtime dependencies"
          command: sudo -u lightning mix lightning.install_runtime

      - save_cache:
          key: v6-deps-{{ arch }}-{{ checksum ".elixir_otp_version" }}-{{ checksum "mix.lock" }}
          paths:
            - _build
            - deps
            - ~/.mix

      # Restore and build PLT for Dialyzer
      - restore_cache:
          name: "Restore PLT cache"
          keys:
            - v6-plt-{{ arch }}-{{ checksum ".elixir_otp_version" }}-{{ checksum "mix.lock" }}
            - v6-plt-{{ arch }}-{{ checksum ".elixir_otp_version" }}

      - run:
          name: "Ensure PLT directory exists"
          command: mkdir -p priv/plts && chown -R lightning priv/plts

      - run:
          name: "Build Dialyzer PLT"
          command: sudo -u lightning env MIX_ENV=test mix dialyzer --plt

      - save_cache:
          key: v6-plt-{{ arch }}-{{ checksum ".elixir_otp_version" }}-{{ checksum "mix.lock" }}
          paths:
            - priv/plts

      # Persist everything to workspace for downstream jobs
      - persist_to_workspace:
          root: /home/lightning/project
          paths:
            - .

  # ============================================================================
  # CHECK JOBS - Fast, parallel jobs that use the pre-built workspace
  # ============================================================================
  check_formatting:
    executor: elixir
    steps:
      - setup_lightning_user
      - attach_built_workspace
      - run:
          name: "Check code formatting"
          command: sudo -u lightning mix format --check-formatted

  check_credo:
    executor: elixir
    steps:
      - setup_lightning_user
      - attach_built_workspace
      - run:
          name: "Check code style with Credo"
          command: sudo -u lightning mix credo --strict --all

  check_dialyzer:
    executor: elixir
    steps:
      - setup_lightning_user
      - attach_built_workspace
      - run:
          name: "Run Dialyzer type checking"
          command: sudo -u lightning mix dialyzer

  check_sobelow:
    executor: elixir
    steps:
      - setup_lightning_user
      - attach_built_workspace
      - run:
          name: "Check for security vulnerabilities"
          command: sudo -u lightning mix sobelow --threshold medium

  test_elixir:
    executor: elixir_with_postgres
    steps:
      - setup_lightning_user
      - attach_built_workspace
      - install_node:
          version: *nodejs_version
      - run:
          name: "Setup test database"
          command: sudo -u lightning mix do ecto.create, ecto.migrate
      - run:
          name: "Run Elixir tests"
          command: sudo -u lightning ./bin/ci_tests
      - codecov/upload:
          file: test/reports/coverage.json
      - store_test_results:
          path: test/reports/

  test_javascript:
    executor: elixir
    steps:
      - setup_lightning_user
      - attach_built_workspace
      - install_node:
          version: *nodejs_version
      - run:
          name: "Run JavaScript tests"
          command: cd assets && sudo -u lightning npm run test-report
      - store_test_results:
          path: test/reports/

workflows:
  pre-flight checks:
    jobs:
      # First: compile everything once
      - compile

      # Then: run all checks in parallel using the compiled workspace
      - check_formatting:
          requires: [compile]
      - check_credo:
          requires: [compile]
      - check_dialyzer:
          requires: [compile]
      - check_sobelow:
          requires: [compile]
      - test_elixir:
          requires: [compile]
      - test_javascript:
          requires: [compile]
